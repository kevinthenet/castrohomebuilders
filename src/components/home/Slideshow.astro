---
import { v2 as cloudinary } from 'cloudinary';

type ResourceType = {
  asset_id: string;
  public_id: string;
  folder: string;
  filename: string;
  format: string;
  version: number;
  resource_type: 'image';
  type: 'upload';
  created_at: string;
  uploaded_at: string;
  bytes: number;
  backup_bytes: number;
  width: number;
  height: number;
  aspect_ratio: number;
  pixels: number;
  url: string;
  secure_url: string;
  status: string;
  access_mode: string;
  access_control: null;
  etag: string;
  created_by: null;
  uploaded_by: null;
};

type SearchResult = {
  total_count: number;
  time: number;
  next_cursor: string;
  resources: ResourceType[];
  rate_limit_allowed: number;
  rate_limit_reset_at: Date;
  rate_limit_remaining: number;
};

cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_API_SECRET,
  secure: true,
});

let photos = [];

const result: SearchResult = await cloudinary.search
  .expression('folder:castrohomebuilders/projects/*')
  .sort_by('height', 'desc')
  .sort_by('width', 'desc')
  .max_results(100)
  .execute();

photos = result.resources;

const firstImage = photos[0];
const nextFewImages = photos.slice(1, 4);
---

<head>
  {firstImage && <link rel="preload" as="image" href={firstImage.secure_url} />}
  {nextFewImages.map((photo) => <link rel="prefetch" as="image" href={photo.secure_url} />)}
</head>

<div
  x-data={`
  { expanded: false,
    prevImg: ${photos.length - 1},
    currentImg: 0,
    nextImg: 1,
    init() {
      this.prefetchAdjacent();
    },
    prefetchAdjacent() {
      const indices = [this.prevImg, this.currentImg, this.nextImg];
      indices.forEach(idx => {
        const img = new Image();
        img.src = this.$refs['img' + idx]?.src;
      });
    },
    next() {
      this.prevImg = this.currentImg;
      this.currentImg = this.nextImg;
      this.nextImg = this.currentImg + 1 > ${photos.length} - 1 ? 0 : this.currentImg + 1;
      this.prefetchAdjacent();
    },
    prev() {
      this.nextImg = this.currentImg;
      this.currentImg = this.prevImg;
      this.prevImg = this.currentImg - 1 < 0 ? ${photos.length} - 1 : this.currentImg - 1;
      this.prefetchAdjacent();
    }
  }`}
>
  <!-- Regular Slideshow -->
  <div class="relative h-half-screen w-full">
    <div class="relative h-half-screen overflow-hidden rounded-3xl">
      {
        photos.map((photo, index) => (
          <div class="duration-700 ease-in-out">
            <img
              x-ref={`img${index}`}
              src={photo.secure_url}
              class="absolute h-auto w-full cursor-pointer"
              alt="Hero slideshow picture"
              loading={index < 3 ? 'eager' : 'lazy'}
              x-data={`
                {
                  id: ${index},
                  get isCurrent() {
                    return this.currentImg === this.id;
                  },
                }
              `}
              x-show="isCurrent"
              x-cloak
              @click="expanded = true"
            />
          </div>
        ))
      }
    </div>
    <button
      type="button"
      class="group absolute left-0 top-0 z-30 flex h-full cursor-pointer items-center justify-center px-4 focus:outline-none"
      x-on:click.debounce="prev"
    >
      <span
        class="dark:bg-gray-800/30 dark:group-hover:bg-gray-800/60 dark:group-focus:ring-gray-800/70 inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/30 group-hover:outline-none group-hover:ring-4 group-hover:ring-white group-focus:outline-none group-focus:ring-4 group-focus:ring-white"
      >
        <svg
          class="dark:text-gray-800 h-4 w-4 text-white"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 6 10"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 1 1 5l4 4"></path>
        </svg>
        <span class="sr-only">Previous</span>
      </span>
    </button>
    <button
      type="button"
      class="group absolute right-0 top-0 z-30 flex h-full cursor-pointer items-center justify-center px-4 focus:outline-none"
      x-on:click.debounce="next"
    >
      <span
        class="dark:bg-gray-800/30 dark:group-hover:bg-gray-800/60 dark:group-focus:ring-gray-800/70 inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/30 group-hover:outline-none group-hover:ring-4 group-hover:ring-white group-focus:outline-none group-focus:ring-4 group-focus:ring-white"
      >
        <svg
          class="dark:text-gray-800 h-4 w-4 text-white"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 6 10"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="m1 9 4-4-4-4"></path>
        </svg>
        <span class="sr-only">Next</span>
      </span>
    </button>
  </div>

  <!-- Expanded Modal -->
  <div
    x-show="expanded"
    x-cloak
    @click.self="expanded = false"
    @keydown.escape.window="expanded = false"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/95"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
  >
    <div class="relative flex h-full w-full items-center justify-center p-4">
      {
        photos.map((photo, index) => (
          <img
            src={photo.secure_url}
            class="max-h-full max-w-full object-contain"
            alt="Expanded slideshow picture"
            x-data={`
              {
                id: ${index},
                get isCurrent() {
                  return this.currentImg === this.id;
                },
              }
            `}
            x-show="isCurrent"
            x-cloak
          />
        ))
      }

      <!-- Close Button -->
      <button
        type="button"
        class="hover:text-gray-300 absolute right-4 top-4 text-white focus:outline-none"
        @click="expanded = false"
      >
        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span class="sr-only">Close</span>
      </button>

      <!-- Navigation Buttons -->
      <button
        type="button"
        class="group absolute left-4 top-1/2 z-30 flex -translate-y-1/2 cursor-pointer items-center justify-center focus:outline-none"
        x-on:click.stop.debounce="prev"
      >
        <span
          class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-white/30 group-hover:bg-white/50 group-focus:outline-none group-focus:ring-4 group-focus:ring-white"
        >
          <svg
            class="h-6 w-6 text-white"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 6 10"
          >
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 1 1 5l4 4"></path>
          </svg>
          <span class="sr-only">Previous</span>
        </span>
      </button>
      <button
        type="button"
        class="group absolute right-4 top-1/2 z-30 flex -translate-y-1/2 cursor-pointer items-center justify-center focus:outline-none"
        x-on:click.stop.debounce="next"
      >
        <span
          class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-white/30 group-hover:bg-white/50 group-focus:outline-none group-focus:ring-4 group-focus:ring-white"
        >
          <svg
            class="h-6 w-6 text-white"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 6 10"
          >
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="m1 9 4-4-4-4"></path>
          </svg>
          <span class="sr-only">Next</span>
        </span>
      </button>
    </div>
  </div>
</div>
